#!/bin/bash

# å®šä¹‰ .dotfiles ç›®å½•çš„è·¯å¾„
DOTFILES_DIR="$HOME/.dotfiles"

# å®šä¹‰è·å–æäº¤ä¿¡æ¯çš„å‡½æ•°
get_commit_message() {
    local hardware_model=""
    local os_name=""
    local time=$(date +"%Y-%m-%d %H:%M:%S")
    local desktop_env=$(echo $XDG_CURRENT_DESKTOP)
    
    # æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS ç³»ç»Ÿ
        hardware_model=$(system_profiler SPHardwareDataType | grep "Model Identifier" | cut -d ":" -f2 | xargs)
        os_name="macOS $(sw_vers -productVersion)"
    else
        # Linux ç³»ç»Ÿ
        if command -v hostnamectl &> /dev/null; then
            hardware_model=$(hostnamectl | grep "Hardware Model" | cut -d ":" -f2 | xargs)
            os_name=$(hostnamectl | grep "Operating System" | cut -d ":" -f2 | xargs)
        else
            # å¦‚æœæ²¡æœ‰ hostnamectl å‘½ä»¤ï¼Œä½¿ç”¨å…¶ä»–æ–¹æ³•
            hardware_model=$(uname -m)
            os_name=$(uname -s)
        fi
    fi
    
    echo "${hardware_model} - ${os_name} - ${desktop_env} ${time}"
}

# å®šä¹‰å‡½æ•°æ¥å¤„ç†å¤‡ä»½æ“ä½œ
backup() {
    echo "æ­£åœ¨å¤‡ä»½é…ç½®..."

    # å¯¼å‡ºCinnamoné…ç½®
    if [ "$XDG_CURRENT_DESKTOP" = "X-Cinnamon" ]; then
        echo "æ£€æµ‹åˆ°Cinnamonæ¡Œé¢ç¯å¢ƒï¼Œæ­£åœ¨å¯¼å‡ºé…ç½®..."
        
        # å¯¼å‡ºCinnamoné…ç½®åˆ°å½“å‰ç›®å½•
        dconf dump /org/cinnamon/ > "$DOTFILES_DIR/config/cinnamon_config.dconf"
        
        echo "Cinnamoné…ç½®å·²å¯¼å‡ºåˆ°ï¼š$DOTFILES_DIR/config/cinnamon_config.dconf"
    else
        echo "å½“å‰ä¸æ˜¯Cinnamonæ¡Œé¢ç¯å¢ƒï¼Œæ— æ³•å¯¼å‡ºé…ç½®ã€‚"
    fi
    
    # å¯¼å‡º GNOME ç»ˆç«¯é…ç½®æ–‡ä»¶
    dconf dump /org/gnome/terminal/legacy/profiles:/ > $DOTFILES_DIR/config/gnome-terminal-profile.conf

    # å¯¼å‡º GNOME ç»ˆç«¯å¿«æ·é”®è®¾ç½®
    dconf dump /org/gnome/terminal/legacy/keybindings/ >> $DOTFILES_DIR/config/gnome-terminal-profile.conf

    # å¯¼å‡º GNOME Shell å¿«æ·é”®è®¾ç½®
    echo "æ­£åœ¨å¯¼å‡º GNOME Shell å¿«æ·é”®è®¾ç½®..."
    dconf dump /org/gnome/shell/keybindings/ > $DOTFILES_DIR/config/gnome-shell-keybindings.conf
    if [ $? -eq 0 ]; then
        echo "GNOME Shell å¿«æ·é”®è®¾ç½®å·²æˆåŠŸå¯¼å‡ºåˆ°ï¼š$DOTFILES_DIR/config/gnome-shell-keybindings.conf"
    else
        echo "å¯¼å‡º GNOME Shell å¿«æ·é”®è®¾ç½®æ—¶å‡ºé”™"
    fi

    # å¤‡ä»½ cursor é…ç½®
    if [ -f "$DOTFILES_DIR/Scripts/cursor/config_backup.sh" ]; then
        bash $DOTFILES_DIR/Scripts/cursor/config_backup.sh
    fi

    echo "å¤‡ä»½å®Œæˆ"
}

# å®šä¹‰å‡½æ•°æ¥å¤„ç†æ¢å¤æ“ä½œ
restore() {
    sudo flatpak override org.gnome.Photos --env=GTK_THEME=Adwaita-dark  # è®¾ç½®gnome-photosä¸ºæš—è‰²ä¸»é¢˜
    
    echo "æ­£åœ¨æ¢å¤é…ç½®..."
    # é…ç½®gitï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
    if [ -f "$DOTFILES_DIR/Scripts/install/resources/git_config.sh" ]; then
        bash $DOTFILES_DIR/Scripts/install/resources/git_config.sh
    fi

    # æ¢å¤ cursor é…ç½®
    if [ -f "$DOTFILES_DIR/Scripts/cursor/config_restore.sh" ]; then
        bash $DOTFILES_DIR/Scripts/cursor/config_restore.sh
    fi

    echo "æ­£åœ¨æ¢å¤ GNOME ç»ˆç«¯é…ç½®..."
    dconf load / < $DOTFILES_DIR/config/gnome-terminal-profile.conf
    if [ $? -eq 0 ]; then
        echo "GNOME ç»ˆç«¯é…ç½®å·²æˆåŠŸæ¢å¤"
    else
        echo "æ¢å¤ GNOME ç»ˆç«¯é…ç½®æ—¶å‡ºé”™"
    fi
    
    # å®‰è£…å­—ä½“ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å­—ä½“å®‰è£…è„šæœ¬ï¼‰
    echo "æ­£åœ¨å®‰è£…å­—ä½“..."
    if [ -f "$DOTFILES_DIR/scripts/system/install_font.sh" ]; then
        bash "$DOTFILES_DIR/scripts/system/install_font.sh" --noto --force
    else
        echo "è­¦å‘Š: æœªæ‰¾åˆ°å­—ä½“å®‰è£…è„šæœ¬: $DOTFILES_DIR/scripts/system/install_font.sh" >&2
    fi

    #bash $DOTFILES_DIR/Scripts/sync_data.sh restore         # æ¢å¤æ•°æ®
    
    ###########################################################################################
    echo "æ¢å¤å®Œæˆ"
}

pull() {
    cd $DOTFILES_DIR

    # å°† config/ssh ç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ° $HOME/.ssh/id_rsaï¼ˆæœ‰å°±è¦†ç›–ï¼‰
    if [ -f "$DOTFILES_DIR/config/ssh/id_rsa" ]; then
        mkdir -p "$HOME/.ssh"
        cp -f "$DOTFILES_DIR/config/ssh/id_rsa" "$HOME/.ssh/id_rsa"
        chmod 600 "$HOME/.ssh/id_rsa"
        echo "å·²å°† config/ssh/id_rsa å¤åˆ¶åˆ° $HOME/.ssh/id_rsa"
    fi
    
    # é‡ç½®åˆ°æœ€æ–°çš„æäº¤
    git reset --hard
    # è·å–æ‰€æœ‰è¿œç¨‹æ›´æ–°
    git fetch --all
    # é‡ç½®åˆ°è¿œç¨‹ä¸»åˆ†æ”¯
    git reset --hard origin/main

    # æˆåŠŸåæ˜¾ç¤ºå½“å‰æœ€æ–°çŠ¶æ€
    echo ""
    echo "å½“å‰ dotfiles çŠ¶æ€å¦‚ä¸‹ï¼š"
    git --no-pager log -1 --pretty=format:"%C(yellow)%h%Creset %Cgreen%ad%Creset %Cblue%an%Creset %s" --date=short
    echo ""
}

# åŒæ­¥ç‹¬ç«‹ä»“åº“åŠŸèƒ½å·²ç§»é™¤

push() {
    cd $DOTFILES_DIR
    echo "æ­£åœ¨pushé…ç½®ï¼š$DOTFILES_DIR"
    bash $DOTFILES_DIR/bin/dotlink backups    # åŒæ­¥ dotfiles
    git add .

    # æ£€æŸ¥æš‚å­˜åŒºæ–‡ä»¶å¤§å°ï¼Œè¶…è¿‡100MBçš„æ–‡ä»¶ä¸æäº¤
    maxsize=104857600  # 100MB
    files_to_unstage=()
    git diff --cached --name-only | while read filename; do
        if [ -f "$filename" ]; then
            size=$(wc -c <"$filename")
            if [ "$size" -gt "$maxsize" ]; then
                echo "ğŸš« å¿½ç•¥æäº¤ï¼š$filename æ–‡ä»¶è¶…è¿‡ 100MBï¼ˆå®é™…å¤§å°ï¼š$((size / 1024 / 1024)) MBï¼‰"
                files_to_unstage+=("$filename")
            fi
        fi
    done

    # å–æ¶ˆæš‚å­˜è¶…å¤§æ–‡ä»¶
    for file in "${files_to_unstage[@]}"; do
        git reset HEAD -- "$file"
    done

    # è·å–æäº¤ä¿¡æ¯
    commit_message=$(get_commit_message)
    if [ $# -gt 0 ]; then
        extra_msg="$*"
        commit_message="$commit_message - $extra_msg"
    fi

    git commit -m "$commit_message" --allow-empty

    # å°è¯• pushï¼Œå¦‚æœé‡åˆ° remote æœªé…ç½®çš„é”™è¯¯åˆ™è‡ªåŠ¨æ·»åŠ  remote å¹¶é‡è¯•
    git push
    if [ $? -eq 0 ]; then
        echo "å·²æ‰§è¡Œ Git æ¨é€"
    else
        # æ£€æŸ¥æ˜¯å¦æ˜¯ remote æœªé…ç½®çš„é”™è¯¯
        last_output=$(git push 2>&1)
        if echo "$last_output" | grep -q "fatal: No configured push destination"; then
            echo "æœªæ£€æµ‹åˆ°è¿œç¨‹ä»“åº“ï¼Œæ­£åœ¨æ·»åŠ  remote origin..."
            git remote add origin git@gitlab.com:tetsuya.ueno/dotfiles.git
            echo "å·²æ·»åŠ  remote originï¼Œæ­£åœ¨é‡æ–° push å¹¶è®¾ç½® upstream..."
            git push --set-upstream origin main
            if [ $? -eq 0 ]; then
                echo "å·²æ‰§è¡Œ Git æ¨é€"
            else
                echo "Git æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿œç¨‹ä»“åº“é…ç½®"
            fi
        else
            echo "Git æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
            echo "$last_output"
        fi
    fi
}

log() {
    cd $DOTFILES_DIR
    git log --pretty=format:"%C(yellow)%h%Creset %Cgreen%ad%Creset %Cblue%an%Creset %s" --date=short
}

# è§£æå‘½ä»¤è¡Œå‚æ•°
if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 [backup] [restore] [pull] [push] [log]"
    echo "å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªå‚æ•°ï¼Œä¾‹å¦‚: $0 backup pull"
    exit 1
else
    for arg in "$@"; do
        case "$arg" in
            backup)
                backup
                ;;
            restore)
                restore
                ;;
            pull)
                pull
                ;;
            push)
                shift
                push "$@"
                ;;
            log)
                log
                ;;
            *)
                echo "å‚æ•°: $0 [backup] [restore] [pull] [push] [log]"
                exit 1
                ;;
        esac
    done
fi

# å¦‚æœæ²¡æœ‰æä¾›å‚æ•°ï¼Œæ˜¾ç¤ºç”¨æ³•è¯´æ˜
if [ $# -eq 0 ]; then
    echo "ç”¨æ³•: $0 [backup] [restore] [pull] [push] [log]"
    echo "å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªå‚æ•°ï¼Œä¾‹å¦‚: $0 backup pull"
    exit 1
fi